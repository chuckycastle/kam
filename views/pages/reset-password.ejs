<%- include('../layouts/main', { body: `
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-5">
        <div class="card shadow-sm">
          <div class="card-body p-4">
            <h2 class="text-center mb-4">Reset Password</h2>
            <p class="text-muted text-center mb-4">Enter your new password below.</p>

            <div id="alert-container"></div>

            <div id="token-error" class="d-none">
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Invalid or missing reset token. Please request a new password reset link.
              </div>
              <div class="text-center mt-3">
                <a href="/forgot-password" class="btn btn-primary">Request New Link</a>
              </div>
            </div>

            <form id="reset-password-form">
              <input type="hidden" id="token" name="token">

              <div class="mb-3">
                <label for="password" class="form-label">New Password</label>
                <input type="password" class="form-control" id="password" name="password" required minlength="8">
                <div class="form-text">
                  Must be at least 8 characters with uppercase, lowercase, and a number.
                </div>
              </div>

              <div class="mb-3">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
              </div>

              <div id="password-requirements" class="mb-3">
                <small class="text-muted">Password requirements:</small>
                <ul class="list-unstyled mb-0 small">
                  <li id="req-length"><i class="bi bi-x-circle text-danger"></i> At least 8 characters</li>
                  <li id="req-upper"><i class="bi bi-x-circle text-danger"></i> One uppercase letter</li>
                  <li id="req-lower"><i class="bi bi-x-circle text-danger"></i> One lowercase letter</li>
                  <li id="req-number"><i class="bi bi-x-circle text-danger"></i> One number</li>
                </ul>
              </div>

              <button type="submit" class="btn btn-primary w-100" id="submit-btn">
                <span id="btn-text">Reset Password</span>
                <span id="btn-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </form>

            <div class="text-center mt-4">
              <a href="/login"><i class="bi bi-arrow-left"></i> Back to Login</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
`, scripts: `
  <script>
    // Extract token from URL (Supabase sends it as query param or fragment)
    function getResetToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));

      // Try different parameter names Supabase might use
      return urlParams.get('token') ||
             urlParams.get('token_hash') ||
             hashParams.get('token') ||
             hashParams.get('access_token') ||
             urlParams.get('code') ||
             null;
    }

    // Initialize
    const token = getResetToken();
    const form = document.getElementById('reset-password-form');
    const tokenError = document.getElementById('token-error');

    if (!token) {
      form.classList.add('d-none');
      tokenError.classList.remove('d-none');
    } else {
      document.getElementById('token').value = token;
    }

    // Password validation
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirmPassword');

    function updateRequirement(id, met) {
      const el = document.getElementById(id);
      const icon = el.querySelector('i');
      if (met) {
        icon.className = 'bi bi-check-circle text-success';
      } else {
        icon.className = 'bi bi-x-circle text-danger';
      }
    }

    function validatePassword(password) {
      updateRequirement('req-length', password.length >= 8);
      updateRequirement('req-upper', /[A-Z]/.test(password));
      updateRequirement('req-lower', /[a-z]/.test(password));
      updateRequirement('req-number', /[0-9]/.test(password));

      return password.length >= 8 &&
             /[A-Z]/.test(password) &&
             /[a-z]/.test(password) &&
             /[0-9]/.test(password);
    }

    passwordInput.addEventListener('input', () => {
      validatePassword(passwordInput.value);
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const password = passwordInput.value;
      const confirmPassword = confirmInput.value;
      const alertContainer = document.getElementById('alert-container');
      const submitBtn = document.getElementById('submit-btn');
      const btnText = document.getElementById('btn-text');
      const btnSpinner = document.getElementById('btn-spinner');

      alertContainer.innerHTML = '';

      // Client-side validation
      if (!validatePassword(password)) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Password does not meet requirements.</div>';
        return;
      }

      if (password !== confirmPassword) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Passwords do not match.</div>';
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      btnText.textContent = 'Resetting...';
      btnSpinner.classList.remove('d-none');

      try {
        const response = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: document.getElementById('token').value,
            password,
            confirmPassword,
          }),
        });

        const data = await response.json();

        if (data.success) {
          alertContainer.innerHTML = \`
            <div class="alert alert-success">
              <i class="bi bi-check-circle"></i> \${data.data.message}
              <br><small>Redirecting to login...</small>
            </div>
          \`;
          form.classList.add('d-none');
          setTimeout(() => {
            window.location.href = '/login';
          }, 3000);
        } else {
          alertContainer.innerHTML = \`
            <div class="alert alert-danger">
              \${data.error?.message || 'Failed to reset password. Please try again.'}
            </div>
          \`;
        }
      } catch (error) {
        alertContainer.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
      } finally {
        submitBtn.disabled = false;
        btnText.textContent = 'Reset Password';
        btnSpinner.classList.add('d-none');
      }
    });
  </script>
` }) %>
