<%- include('../../layouts/main', { body: `
  <div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/organizations">Organizations</a></li>
        <li class="breadcrumb-item active" id="breadcrumb-name">Loading...</li>
      </ol>
    </nav>

    <div id="org-content">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Loading organization...</p>
      </div>
    </div>
  </div>
`, scripts: `
  <script>
    const orgId = window.location.pathname.split('/')[2];

    async function loadOrganization() {
      try {
        const response = await fetch('/api/orgs/' + orgId);
        const data = await response.json();

        if (!data.success || !data.data) {
          document.getElementById('org-content').innerHTML =
            '<div class="alert alert-danger">Organization not found</div>';
          return;
        }

        const org = data.data;
        document.getElementById('breadcrumb-name').textContent = org.name;

        const statusBadge = org.isAvailable
          ? '<span class="badge bg-success">Available</span>'
          : '<span class="badge bg-secondary">Assigned</span>';

        const assignedInfo = org.assignedTo
          ? '<p class="mb-1"><strong>Assigned To:</strong> ' + escapeHtml(org.assignedTo.firstName + ' ' + org.assignedTo.lastName) + '</p>' +
            '<p class="mb-0"><small class="text-muted">' + escapeHtml(org.assignedTo.email) + '</small></p>'
          : '<p class="text-muted mb-0">Not yet assigned</p>';

        let notesHtml = '<p class="text-muted">No notes yet.</p>';
        if (org.notes && org.notes.length > 0) {
          notesHtml = org.notes.map(note =>
            '<div class="border-bottom py-2">' +
              '<p class="mb-1">' + escapeHtml(note.content) + '</p>' +
              '<small class="text-muted">' + escapeHtml(note.author?.firstName + ' ' + note.author?.lastName) +
              ' - ' + new Date(note.createdAt).toLocaleDateString() + '</small>' +
            '</div>'
          ).join('');
        }

        let itemsHtml = '<p class="text-muted">No items yet.</p>';
        if (org.items && org.items.length > 0) {
          itemsHtml = '<div class="list-group list-group-flush">' +
            org.items.map(item =>
              '<a href="/items/' + item.id + '" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">' +
                '<span>' + escapeHtml(item.name) + '</span>' +
                '<span class="badge bg-' + getStatusColor(item.status) + '">' + item.status + '</span>' +
              '</a>'
            ).join('') + '</div>';
        }

        document.getElementById('org-content').innerHTML =
          '<div class="d-flex justify-content-between align-items-start mb-4">' +
            '<div>' +
              '<h1 class="h2 mb-2">' + escapeHtml(org.name) + ' ' + statusBadge + '</h1>' +
              '<p class="text-muted mb-0">' + (org.category?.name || 'Uncategorized') + '</p>' +
            '</div>' +
            '<div>' +
              '<a href="/organizations/' + org.id + '/edit" class="btn btn-outline-primary me-2">' +
                '<i class="bi bi-pencil me-1"></i> Edit' +
              '</a>' +
              '<button class="btn btn-outline-danger" onclick="deleteOrganization()">' +
                '<i class="bi bi-trash me-1"></i> Delete' +
              '</button>' +
            '</div>' +
          '</div>' +

          '<div class="row g-4">' +
            '<div class="col-md-8">' +
              '<div class="card border-0 shadow-sm mb-4">' +
                '<div class="card-header bg-white"><h5 class="mb-0">Details</h5></div>' +
                '<div class="card-body">' +
                  (org.description ? '<p>' + escapeHtml(org.description) + '</p>' : '') +
                  (org.url ? '<p><strong>Website:</strong> <a href="' + escapeHtml(org.url) + '" target="_blank">' + escapeHtml(org.url) + '</a></p>' : '') +
                  '<hr>' +
                  '<h6>Contact Information</h6>' +
                  '<p class="mb-1"><strong>' + escapeHtml(org.contactName || '-') + '</strong></p>' +
                  (org.contactTitle ? '<p class="mb-1 text-muted">' + escapeHtml(org.contactTitle) + '</p>' : '') +
                  (org.contactPhone ? '<p class="mb-1"><i class="bi bi-telephone me-2"></i>' + escapeHtml(org.contactPhone) + '</p>' : '') +
                  (org.contactEmail ? '<p class="mb-0"><i class="bi bi-envelope me-2"></i>' + escapeHtml(org.contactEmail) + '</p>' : '') +
                '</div>' +
              '</div>' +

              '<div class="card border-0 shadow-sm">' +
                '<div class="card-header bg-white d-flex justify-content-between align-items-center">' +
                  '<h5 class="mb-0">Items (' + (org.items?.length || 0) + ')</h5>' +
                  '<a href="/items/new?orgId=' + org.id + '" class="btn btn-sm btn-primary">' +
                    '<i class="bi bi-plus-lg"></i> Add Item' +
                  '</a>' +
                '</div>' +
                '<div class="card-body p-0">' + itemsHtml + '</div>' +
              '</div>' +
            '</div>' +

            '<div class="col-md-4">' +
              '<div class="card border-0 shadow-sm mb-4">' +
                '<div class="card-header bg-white"><h5 class="mb-0">Assignment</h5></div>' +
                '<div class="card-body">' +
                  assignedInfo +
                  (org.isAvailable ?
                    '<button class="btn btn-primary w-100 mt-3" onclick="assignToMe()"><i class="bi bi-person-plus me-1"></i> Assign to Me</button>'
                    : '') +
                '</div>' +
              '</div>' +

              '<div class="card border-0 shadow-sm">' +
                '<div class="card-header bg-white d-flex justify-content-between align-items-center">' +
                  '<h5 class="mb-0">Notes</h5>' +
                  '<button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">' +
                    '<i class="bi bi-plus-lg"></i>' +
                  '</button>' +
                '</div>' +
                '<div class="card-body">' + notesHtml + '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +

          '<!-- Add Note Modal -->' +
          '<div class="modal fade" id="addNoteModal" tabindex="-1">' +
            '<div class="modal-dialog">' +
              '<div class="modal-content">' +
                '<div class="modal-header">' +
                  '<h5 class="modal-title">Add Note</h5>' +
                  '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
                '</div>' +
                '<div class="modal-body">' +
                  '<textarea class="form-control" id="note-content" rows="4" placeholder="Enter your note..."></textarea>' +
                '</div>' +
                '<div class="modal-footer">' +
                  '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>' +
                  '<button type="button" class="btn btn-primary" onclick="addNote()">Add Note</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>';

      } catch (error) {
        console.error('Failed to load organization:', error);
        document.getElementById('org-content').innerHTML =
          '<div class="alert alert-danger">Failed to load organization</div>';
      }
    }

    function getStatusColor(status) {
      const colors = {
        'PENDING': 'warning',
        'RECEIVED': 'success',
        'NOT_AVAILABLE': 'secondary',
        'DECLINED': 'danger'
      };
      return colors[status] || 'secondary';
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function deleteOrganization() {
      if (!confirm('Are you sure you want to delete this organization?')) return;

      try {
        const response = await fetch('/api/orgs/' + orgId, { method: 'DELETE' });
        const data = await response.json();

        if (data.success) {
          window.location.href = '/organizations';
        } else {
          alert(data.error?.message || 'Failed to delete organization');
        }
      } catch (error) {
        alert('Failed to delete organization');
      }
    }

    async function assignToMe() {
      try {
        const meResponse = await fetch('/api/auth/me');
        const meData = await meResponse.json();

        if (!meData.success || !meData.data?.user) {
          alert('Please log in to assign organizations');
          return;
        }

        const response = await fetch('/api/orgs/' + orgId + '/assign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: meData.data.user.id })
        });

        const data = await response.json();

        if (data.success) {
          loadOrganization();
        } else {
          alert(data.error?.message || 'Failed to assign organization');
        }
      } catch (error) {
        alert('Failed to assign organization');
      }
    }

    async function addNote() {
      const content = document.getElementById('note-content').value.trim();
      if (!content) {
        alert('Please enter a note');
        return;
      }

      try {
        const response = await fetch('/api/notes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content, organizationId: orgId })
        });

        const data = await response.json();

        if (data.success) {
          bootstrap.Modal.getInstance(document.getElementById('addNoteModal')).hide();
          document.getElementById('note-content').value = '';
          loadOrganization();
        } else {
          alert(data.error?.message || 'Failed to add note');
        }
      } catch (error) {
        alert('Failed to add note');
      }
    }

    loadOrganization();
  </script>
` }) %>
