<%- include('../../layouts/main', { body: `
  <div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/items">Items</a></li>
        <li class="breadcrumb-item active" id="breadcrumb-name">Loading...</li>
      </ol>
    </nav>

    <div id="item-content">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Loading item...</p>
      </div>
    </div>
  </div>
`, scripts: `
  <script>
    const itemId = window.location.pathname.split('/')[2];

    async function loadItem() {
      try {
        const response = await fetch('/api/items/' + itemId);
        const data = await response.json();

        if (!data.success || !data.data) {
          document.getElementById('item-content').innerHTML =
            '<div class="alert alert-danger">Item not found</div>';
          return;
        }

        const item = data.data;
        document.getElementById('breadcrumb-name').textContent = item.name;

        const statusBadge = item.isReceived
          ? '<span class="badge bg-success">Received</span>'
          : '<span class="badge bg-warning text-dark">Pending</span>';

        const value = item.value ? '$' + Number(item.value).toLocaleString() : 'Not specified';
        const createdDate = new Date(item.createdAt).toLocaleDateString();
        const receivedDate = item.receivedAt ? new Date(item.receivedAt).toLocaleDateString() : null;

        const creator = item.createdBy
          ? item.createdBy.firstName + ' ' + item.createdBy.lastName
          : 'Unknown';

        document.getElementById('item-content').innerHTML =
          '<div class="d-flex justify-content-between align-items-start mb-4">' +
            '<div>' +
              '<h1 class="h2 mb-2">' + escapeHtml(item.name) + ' ' + statusBadge + '</h1>' +
              '<p class="text-muted mb-0">' +
                'From <a href="/organizations/' + item.organization?.id + '">' +
                escapeHtml(item.organization?.name || 'Unknown Organization') + '</a>' +
              '</p>' +
            '</div>' +
            '<div>' +
              (!item.isReceived ?
                '<button class="btn btn-success me-2" onclick="markReceived()">' +
                  '<i class="bi bi-check-lg me-1"></i> Mark Received' +
                '</button>' : '') +
              '<a href="/items/' + item.id + '/edit" class="btn btn-outline-primary me-2">' +
                '<i class="bi bi-pencil me-1"></i> Edit' +
              '</a>' +
              '<button class="btn btn-outline-danger" onclick="deleteItem()">' +
                '<i class="bi bi-trash me-1"></i> Delete' +
              '</button>' +
            '</div>' +
          '</div>' +

          '<div class="row g-4">' +
            '<div class="col-md-8">' +
              '<div class="card border-0 shadow-sm">' +
                '<div class="card-header bg-white"><h5 class="mb-0">Item Details</h5></div>' +
                '<div class="card-body">' +
                  (item.description ? '<p class="mb-4">' + escapeHtml(item.description) + '</p>' : '<p class="text-muted mb-4">No description provided.</p>') +
                  '<div class="row">' +
                    '<div class="col-md-6 mb-3">' +
                      '<label class="text-muted small">Estimated Value</label>' +
                      '<p class="h5 mb-0">' + value + '</p>' +
                    '</div>' +
                    '<div class="col-md-6 mb-3">' +
                      '<label class="text-muted small">Quantity</label>' +
                      '<p class="h5 mb-0">' + (item.quantity || 1) + '</p>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div class="col-md-4">' +
              '<div class="card border-0 shadow-sm mb-4">' +
                '<div class="card-header bg-white"><h5 class="mb-0">Status</h5></div>' +
                '<div class="card-body">' +
                  '<p class="mb-2"><strong>Status:</strong> ' + (item.isReceived ? 'Received' : 'Pending') + '</p>' +
                  '<p class="mb-2"><strong>Created:</strong> ' + createdDate + '</p>' +
                  (receivedDate ? '<p class="mb-0"><strong>Received:</strong> ' + receivedDate + '</p>' : '') +
                '</div>' +
              '</div>' +

              '<div class="card border-0 shadow-sm">' +
                '<div class="card-header bg-white"><h5 class="mb-0">Organization Contact</h5></div>' +
                '<div class="card-body">' +
                  '<p class="mb-1"><strong>' + escapeHtml(item.organization?.contactName || '-') + '</strong></p>' +
                  (item.organization?.contactEmail ?
                    '<p class="mb-0"><a href="mailto:' + escapeHtml(item.organization.contactEmail) + '">' +
                    escapeHtml(item.organization.contactEmail) + '</a></p>' : '') +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>';

      } catch (error) {
        console.error('Failed to load item:', error);
        document.getElementById('item-content').innerHTML =
          '<div class="alert alert-danger">Failed to load item</div>';
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function deleteItem() {
      if (!confirm('Are you sure you want to delete this item?')) return;

      try {
        const response = await fetch('/api/items/' + itemId, { method: 'DELETE' });
        const data = await response.json();

        if (data.success) {
          window.location.href = '/items';
        } else {
          alert(data.error?.message || 'Failed to delete item');
        }
      } catch (error) {
        alert('Failed to delete item');
      }
    }

    async function markReceived() {
      try {
        const response = await fetch('/api/items/' + itemId + '/receive', {
          method: 'POST',
        });
        const data = await response.json();

        if (data.success) {
          loadItem();
        } else {
          alert(data.error?.message || 'Failed to mark item as received');
        }
      } catch (error) {
        alert('Failed to mark item as received');
      }
    }

    loadItem();
  </script>
` }) %>
